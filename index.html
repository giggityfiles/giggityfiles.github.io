<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Giggity Files</title>
<meta name="description" content="Browse, search, and download files from all Giggity Files repositories." />
<link href="https://fonts.googleapis.com/css2?family=Oswald&display=swap" rel="stylesheet" />
<style>
body { font-family:'Oswald',sans-serif; background:#111; color:#fff; margin:0; padding:0; }
header { background:#222; padding:20px; text-align:center; border-bottom:2px solid #ffcc00; }
header h1 { margin:0; font-size:2.5em; }
#quote { margin-top:5px; color:#ccc; }
#news { margin:10px auto; padding:10px; background:#222; border-left:4px solid #ffcc00; max-width:800px; white-space:pre-wrap; }
#promos { margin:10px auto; display:flex; flex-direction:column; gap:5px; max-width:800px; }
#promos a { color:#ffcc00; text-decoration:none; font-weight:bold; }
#controls { display:flex; justify-content:center; gap:10px; padding:15px; }
#searchBox { padding:8px; width:200px; }
#sortSelect { padding:8px; }
main { padding:20px; }
.repo { margin-bottom:30px; }
.repo h2 { color:#00ccff; font-size:1.5em; }
ul.file-list { list-style:none; padding-left:20px; }
ul.file-list li { display:flex; align-items:center; margin:4px 0; }
ul.file-list img { width:20px; height:20px; margin-right:8px; }
a { color:#ffcc00; text-decoration:none; }
a:hover { text-decoration:underline; }
footer { text-align:center; padding:15px; background:#222; font-size:0.9em; color:#aaa; margin-top:20px; }
#ipBox { margin:10px; text-align:center; color:#ffcc00; }
#toggleIP { margin-left:10px; padding:5px; cursor:pointer; }
</style>
</head>
<body>
<header>
<h1>Giggity Files</h1>
<p id="quote"></p>
<div id="news">Loading newsâ€¦</div>
<div id="promos">
  <a href="https://giggityfiles.github.io/ads.html" target="_blank">Check out our promos! ðŸŽ‰</a>
  <a href="https://giggityfiles.github.io/pullreq" target="_blank">Request a file here ðŸ“‚</a>
  <a href="https://ggtfiles.blogspot.com" target="_blank">Official Blog</a>
  <a href="https://ggtfiles.fandom.com" target="_blank">Official Fandom Wiki</a>
</div>
<div id="ipBox">
  <span id="ipDisplay">Loading your IP...</span>
  <button id="toggleIP">Hide IP</button>
</div>
<div id="controls">
  <input type="text" id="searchBox" placeholder="Search files..." aria-label="Search files" />
  <select id="sortSelect" aria-label="Sort files">
    <option value="az">Sort A â†’ Z</option>
    <option value="za">Sort Z â†’ A</option>
  </select>
</div>
</header>

<main>
  <div id="repos">Loading filesâ€¦</div>
</main>

<footer>Note: Some Windows apps may require Wine for non-Windows systems.</footer>

<script>
const username = 'giggityfiles';
const iconURL = 'https://img.icons8.com/?size=256&id=1u78UgAkC1bw&format=png';
const baseDL = 'https://giggityfiles.github.io';
const IGNORED_EXT = /\.(html|md|txt|json|yml|yaml|gitignore|gitattributes)$/i;

// === Configuration ===
const bannedIPs = ["123.45.67.89", "98.76.54.32"]; // Add IPs here to ban
let showIP = localStorage.getItem('showIP') !== 'false'; // Toggle state persists
let repos = [];
const fileCache = {};

// === Random quote ===
const quotes = [
  "Giggity giggity goo!",
  "Stay updated with Giggity Files.",
  "Where files meet fun.",
  "Fast. Simple. Giggity."
];
document.getElementById('quote').innerText = quotes[Math.floor(Math.random() * quotes.length)];

// === Sanitize HTML for news ===
function sanitizeHTML(input) {
  const allowedTags = ['b', 'i', 'u', 'a', 'br', 'strong', 'em', 'p', 'ul', 'ol', 'li', 'marquee'];
  const div = document.createElement('div');
  div.innerHTML = input;

  const sanitizeNode = node => {
    if (node.nodeType === 1) {
      if (!allowedTags.includes(node.tagName.toLowerCase())) {
        node.replaceWith(...Array.from(node.childNodes));
        return;
      }
      if (node.tagName.toLowerCase() === 'a') {
        node.setAttribute('target', '_blank');
        node.setAttribute('rel', 'noopener noreferrer');
      }
    }
    node.childNodes.forEach(sanitizeNode);
  };
  div.childNodes.forEach(sanitizeNode);
  return div.innerHTML;
}

// === Load news ===
async function loadNews() {
  const newsDiv = document.getElementById('news');
  try {
    const res = await fetch('https://giggityfiles.github.io/news.txt');
    let text = await res.text();
    text = sanitizeHTML(text);
    newsDiv.innerHTML = `<strong>News:</strong><br>${text}`;
  } catch {
    newsDiv.innerText = "Failed to load news.";
  }
}

// === Load IP ===
async function loadIP() {
  const ipDisplay = document.getElementById('ipDisplay');
  try {
    const res = await fetch('https://api64.ipify.org?format=json');
    const data = await res.json();
    const ip = data.ip;

    // Ban check
    if (bannedIPs.includes(ip)) {
      window.location.href = 'https://slimetube.github.io';
      return;
    }

    ipDisplay.innerText = showIP ? `Your IP: ${ip}` : 'IP hidden';
  } catch {
    ipDisplay.innerText = 'Unable to fetch IP';
  }
}

// === Toggle IP visibility ===
document.getElementById('toggleIP').addEventListener('click', () => {
  showIP = !showIP;
  localStorage.setItem('showIP', showIP);
  loadIP();
});

// === Fetch Repos ===
async function fetchRepos() {
  const res = await fetch(`https://api.github.com/users/${username}/repos`);
  const data = await res.json();
  return data.filter(r => r.name.toLowerCase() !== 'giggityfiles.github.io');
}

// === Recursive file fetch with caching ===
async function fetchAllFiles(repo, path = '') {
  const cacheKey = `${repo}/${path}`;
  if (fileCache[cacheKey]) return fileCache[cacheKey];

  const res = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${path}`);
  if (!res.ok) return [];
  const items = await res.json();
  let files = [];
  for (const item of items) {
    if (item.type === 'file' && !IGNORED_EXT.test(item.name)) {
      files.push({ name: item.name, path: item.path, repo });
    } else if (item.type === 'dir') {
      files = files.concat(await fetchAllFiles(repo, item.path));
    }
  }
  fileCache[cacheKey] = files;
  return files;
}

// === Render repositories ===
async function render() {
  const searchTerm = document.getElementById('searchBox').value.toLowerCase();
  const sortOrder = document.getElementById('sortSelect').value;
  const container = document.getElementById('repos');
  container.innerHTML = 'Loading files, please wait...';

  let content = '';
  for (const repo of repos) {
    const files = await fetchAllFiles(repo.name);
    const filtered = files.filter(f => f.name.toLowerCase().includes(searchTerm));
    filtered.sort((a, b) => sortOrder === 'az' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name));

    if (!filtered.length) continue;
    content += `<div class="repo"><h2>${repo.name}</h2><ul class="file-list">`;
    filtered.forEach(f => {
      content += `<li><img src="${iconURL}" alt="icon"><a href="${baseDL}/${f.repo}/${f.path}" download>${f.path}</a></li>`;
    });
    content += '</ul></div>';
  }
  container.innerHTML = content || 'No matching files found.';
}

// === Event listeners ===
document.getElementById('searchBox').addEventListener('input', render);
document.getElementById('sortSelect').addEventListener('change', render);

// === Initialize ===
(async () => {
  await loadIP();
  repos = await fetchRepos();
  loadNews();
  render();
})();
</script>
</body>
</html>
