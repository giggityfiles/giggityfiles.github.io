<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Giggity Files</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Oswald', sans-serif; margin:0; background:#111; color:#eee; }
  h1 { text-align:center; margin:1em 0; }
  #news { padding:1em; background:#222; }
  #promos { text-align:center; padding:1em; background:#181818; }
  #promos a { margin:0 10px; color:#4af; text-decoration:none; }
  #promos a:hover { text-decoration:underline; }
  #controls { text-align:center; margin:1em 0; }
  #search, #sort { padding:5px; font-size:1em; }
  #ipBox { text-align:center; margin:1em; color:#ffcc00; }
  #toggleIP { margin-left:10px; padding:3px 6px; cursor:pointer; font-size:0.9em; }
  .repo { border:1px solid #444; margin:0.5em; border-radius:5px; }
  .repo h2 { margin:0; padding:0.5em; background:#333; cursor:pointer; font-size:1.2em; }
  .file-list { display:none; padding:0.5em; list-style:none; }
  .file-list li { margin:0.25em 0; }
  .file-list img { width:16px; vertical-align:middle; margin-right:5px; }
  .file-list a { color:#fff; font-size:1.1em; text-decoration:none; }
  .file-list a:hover { text-decoration:underline; }
</style>
</head>
<body>
<h1>Giggity Files</h1>

<div id="news">Loading news…</div>

<div id="promos">
  <a href="https://giggityfiles.github.io/ads.html" target="_blank">Check out our promos</a>
  <a href="https://giggityfiles.github.io/pullreq" target="_blank">Request a file here</a>
  <a href="https://ggtfiles.blogspot.com" target="_blank">Official Blog</a>
  <a href="https://ggtfiles.fandom.com" target="_blank">Official Fandom Wiki</a>
  <a href="https://giggityfiles.github.io/links.html" target="_blank">Links</a>
</div>

<div id="ipBox">
  <span id="ipDisplay">Loading your IP…</span>
  <button id="toggleIP">Hide IP</button>
</div>

<div id="controls">
  <input type="text" id="search" placeholder="Search repos…" oninput="filterRepos()" />
  <select id="sort" onchange="sortRepos()">
    <option value="az">Sort: A–Z</option>
    <option value="za">Sort: Z–A</option>
  </select>
</div>

<div id="repos">Loading repos…</div>

<script>
const baseAPI = "https://api.github.com/repos/giggityfiles";
const baseDL = "https://giggityfiles.github.io";
const iconURL = "https://img.icons8.com/?size=256&id=1u78UgAkC1bw&format=png";
const bannedURL = "https://giggityfiles.github.io/bans.json";

let showIP = localStorage.getItem('showIP') !== 'false';
let userIP = null;

// Fetch IPv4
async function fetchIPv4() {
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    return (await res.json()).ip;
  } catch {
    try {
      const res = await fetch("https://ipv4.icanhazip.com");
      return (await res.text()).trim();
    } catch {
      return null;
    }
  }
}

// Display IP
function displayIP() {
  const ipDisplay = document.getElementById('ipDisplay');
  ipDisplay.innerText = showIP ? `Your IP: ${userIP || 'unknown'}` : 'IP hidden';
}

// Toggle IP visibility
document.getElementById('toggleIP').addEventListener('click', () => {
  showIP = !showIP;
  localStorage.setItem('showIP', showIP);
  displayIP();
});

// Ban check: instantly redirect
async function checkBan() {
  if (!userIP) return;
  try {
    const res = await fetch(`${bannedURL}?_=${Date.now()}`);
    const bannedIPs = await res.json();
    if (bannedIPs.includes(userIP)) {
      window.location.href = "/blocked";
    }
  } catch {}
}

// Ban check every second
setInterval(checkBan, 1000);

// Repos data
let reposAll = [];
let reposFiltered = [];

// Load repos
async function loadRepos() {
  try {
    const res = await fetch("https://api.github.com/users/giggityfiles/repos");
    const repos = await res.json();
    reposAll = repos.filter(r => r.name !== "giggityfiles.github.io");
    reposFiltered = [...reposAll];
    renderRepos();
  } catch {
    document.getElementById("repos").innerText = "Failed to load repos.";
  }
}

// Render repos
function renderRepos() {
  let html = "";
  for (const repo of reposFiltered) {
    html += `
      <div class="repo">
        <h2 onclick="toggleRepo('${repo.name}')">${repo.name}</h2>
        <ul id="files-${repo.name}" class="file-list"></ul>
      </div>
    `;
  }
  document.getElementById("repos").innerHTML = html;
}

// Toggle repo files
async function toggleRepo(repoName) {
  const list = document.getElementById(`files-${repoName}`);
  if (list.style.display === "block") {
    list.style.display = "none";
    return;
  }
  if (!list.dataset.loaded) {
    try {
      const res = await fetch(`${baseAPI}/${repoName}/contents`);
      const files = await res.json();
      list.innerHTML = files.map(f => `
        <li><img src="${iconURL}"><a href="${baseDL}/${repoName}/${f.path}" download>${f.path}</a></li>
      `).join("");
      list.dataset.loaded = "true";
    } catch {
      list.innerHTML = "<li>Failed to load files.</li>";
    }
  }
  list.style.display = "block";
}

// Search & sort
function filterRepos() {
  const q = document.getElementById("search").value.toLowerCase();
  reposFiltered = reposAll.filter(r => r.name.toLowerCase().includes(q));
  renderRepos();
}
function sortRepos() {
  const mode = document.getElementById("sort").value;
  reposFiltered.sort((a,b) => mode === "az" ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name));
  renderRepos();
}

// Load news
async function loadNews() {
  try {
    const res = await fetch(`${baseDL}/news.txt?${Date.now()}`);
    const text = await res.text();
    document.getElementById("news").innerText = text;
  } catch {
    document.getElementById("news").innerText = "Failed to load news.";
  }
}

// Initialize
(async () => {
  userIP = await fetchIPv4();
  displayIP();
  await checkBan();
  setInterval(checkBan, 1000);
  loadRepos();
  loadNews();
})();
</script>
</body>
</html>
