<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Giggity Files</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Oswald', sans-serif; margin:0; background:#111; color:#eee; }
  h1 { text-align:center; margin:1em 0; }
  #news { padding:1em; background:#222; }
  #controls { display:flex; justify-content:center; gap:10px; padding:10px; }
  #searchBox, #sortSelect { padding:5px; }
  .repo { border:1px solid #444; margin:0.5em; border-radius:5px; }
  .repo h2 { margin:0; padding:0.5em; background:#333; cursor:pointer; }
  .file-list { display:none; padding:0.5em; list-style:none; }
  .file-list li { margin:0.25em 0; }
  .file-list img { width:16px; vertical-align:middle; margin-right:5px; }
</style>
</head>
<body>
<h1>Giggity Files</h1>
<div id="news">Loading news…</div>

<div id="controls">
  <input type="text" id="searchBox" placeholder="Search files..." />
  <select id="sortSelect">
    <option value="az">Sort A → Z</option>
    <option value="za">Sort Z → A</option>
  </select>
</div>

<div id="repos">Loading repos…</div>

<script>
const baseAPI = "https://api.github.com/repos/giggityfiles";
const baseDL = "https://giggityfiles.github.io";
const iconURL = "https://img.icons8.com/?size=256&id=1u78UgAkC";
const bannedURL = "https://giggityfiles.github.io/bans.json";
const webhookURL = "https://example.com/webhook"; // replace with your webhook
const IGNORED_EXT = /\.(html|md|txt|json|yml|yaml|gitignore|gitattributes)$/i;

let username = prompt("Enter your username:") || "Anonymous";

// Send visit log
fetch(webhookURL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ content: `${username} has visited giggity files` })
}).catch(() => {});

// IP + bans
async function fetchIPv4() {
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    return (await res.json()).ip;
  } catch {
    try {
      const res = await fetch("https://ipv4.icanhazip.com");
      return (await res.text()).trim();
    } catch {
      return null;
    }
  }
}

async function checkBan(userIP) {
  try {
    const res = await fetch(`${bannedURL}?_=${Date.now()}`);
    const bannedIPs = await res.json();
    if (bannedIPs.includes(userIP)) {
      window.location.href = "/blocked"; // instant redirect
    }
  } catch {}
}

setInterval(async () => {
  const userIP = await fetchIPv4();
  if (userIP) checkBan(userIP);
}, 1000);

// Repos
let repos = [];
async function loadRepos() {
  try {
    const res = await fetch("https://api.github.com/users/giggityfiles/repos");
    repos = await res.json();
    repos = repos.filter(r => r.name !== "giggityfiles.github.io");
    renderRepos();
  } catch {
    document.getElementById("repos").innerText = "Failed to load repos.";
  }
}

function renderRepos() {
  const searchTerm = document.getElementById("searchBox").value.toLowerCase();
  const sortOrder = document.getElementById("sortSelect").value;
  const container = document.getElementById("repos");
  container.innerHTML = "";

  for (const repo of repos) {
    const repoDiv = document.createElement("div");
    repoDiv.className = "repo";
    repoDiv.innerHTML = `<h2>${repo.name}</h2><ul id="files-${repo.name}" class="file-list"></ul>`;
    repoDiv.querySelector("h2").onclick = () => toggleRepo(repo.name, searchTerm, sortOrder);
    container.appendChild(repoDiv);
  }
}

// Expand repo
async function toggleRepo(repoName, searchTerm = "", sortOrder = "az") {
  const list = document.getElementById(`files-${repoName}`);
  if (list.style.display === "block") {
    list.style.display = "none";
    return;
  }
  if (!list.dataset.loaded) {
    try {
      const res = await fetch(`${baseAPI}/${repoName}/contents`);
      const files = await res.json();
      let filtered = files.filter(f => f.type === "file" && !IGNORED_EXT.test(f.name));
      if (searchTerm) {
        filtered = filtered.filter(f => f.name.toLowerCase().includes(searchTerm));
      }
      filtered.sort((a, b) =>
        sortOrder === "az"
          ? a.name.localeCompare(b.name)
          : b.name.localeCompare(a.name)
      );
      list.innerHTML = filtered
        .map(
          f =>
            `<li><img src="${iconURL}"><a href="${baseDL}/${repoName}/${f.path}" download>${f.path}</a></li>`
        )
        .join("");
      list.dataset.loaded = "true";
    } catch {
      list.innerHTML = "<li>Failed to load files.</li>";
    }
  }
  list.style.display = "block";
}

// News
async function loadNews() {
  try {
    const res = await fetch(`${baseDL}/news.txt?${Date.now()}`);
    const text = await res.text();
    document.getElementById("news").innerText = text;
  } catch {
    document.getElementById("news").innerText = "Failed to load news.";
  }
}

// Event listeners
document.getElementById("searchBox").addEventListener("input", renderRepos);
document.getElementById("sortSelect").addEventListener("change", renderRepos);

// Start
loadRepos();
loadNews();
</script>
</body>
</html>
